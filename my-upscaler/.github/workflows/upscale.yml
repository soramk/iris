name: Upscale Image

on:
  push:
    paths:
      - 'input/**' # inputフォルダへの追加をトリガーにする

permissions:
  contents: write # 結果を書き込む権限

jobs:
  upscale:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Real-ESRGAN (Download Binary)
        run: |
          # Real-ESRGANの実行ファイルをダウンロードして権限付与
          wget https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesrgan-ncnn-vulkan-20220424-ubuntu.zip
          unzip realesrgan-ncnn-vulkan-20220424-ubuntu.zip
          chmod +x realesrgan-ncnn-vulkan
          
          # outputフォルダがなければ作成
          mkdir -p output

      - name: Process Images
        run: |
          # inputフォルダ内の画像を探してループ処理
          # ※実際は直近Pushされたファイルだけを対象にするのがスマートですが、
          #   今回は簡易化のためinput内の全ファイルを対象にします（上書きモード）
          
          for file in input/*; do
            filename=$(basename "$file")
            echo "Processing: $filename"
            
            # ファイル名から倍率を抽出 (デフォルトは4倍)
            scale=4
            if [[ "$filename" == *"_x2"* ]]; then scale=2; fi
            if [[ "$filename" == *"_x3"* ]]; then scale=3; fi
            
            # 実行 (CPUモードでも動くようにVulkanドライバ周りのエラーは無視して強行するか、
            # ubuntu-latestに含まれるソフトウェアレンダラを使用します)
            ./realesrgan-ncnn-vulkan -i "$file" -o "output/upscaled_$filename" -s $scale
          done

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # outputフォルダの変更があればコミット
          git add output/
          
          # 変更がない場合のエラー回避
          git commit -m "Add upscaled images" || echo "No changes to commit"
          git push
