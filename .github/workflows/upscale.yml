name: Upscale Image

on:
  push:
    paths:
      - 'my-upscaler/input/**' # my-upscaler/inputフォルダへの追加をトリガーにする

permissions:
  contents: write # 結果を書き込む権限

jobs:
  upscale:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Real-ESRGAN (Download Binary)
        run: |
          # Real-ESRGANの実行ファイルをダウンロードして権限付与
          wget https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesrgan-ncnn-vulkan-20220424-ubuntu.zip
          unzip realesrgan-ncnn-vulkan-20220424-ubuntu.zip
          chmod +x realesrgan-ncnn-vulkan
          
          # outputフォルダがなければ作成
          mkdir -p my-upscaler/output

      - name: Process Images
        run: |
          # my-upscaler/inputフォルダ内の画像を探してループ処理
          for file in my-upscaler/input/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Processing: $filename"
              
              # ファイル名から倍率を抽出 (デフォルトは4倍)
              scale=4
              if [[ "$filename" == *"_x2"* ]]; then scale=2; fi
              if [[ "$filename" == *"_x3"* ]]; then scale=3; fi
              
              # 実行
              ./realesrgan-ncnn-vulkan -i "$file" -o "my-upscaler/output/upscaled_$filename" -s $scale
            fi
          done

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # outputフォルダの変更があればコミット
          git add my-upscaler/output/
          
          # 変更がない場合のエラー回避
          git commit -m "Add upscaled images" || echo "No changes to commit"
          git push
