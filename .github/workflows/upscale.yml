name: Upscale Image

on:
  push:
    paths:
      - "my-upscaler/input/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  upscale:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install Vulkan dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y -q libvulkan1 mesa-vulkan-drivers

      - name: Cache Real-ESRGAN
        id: cache-realesrgan
        uses: actions/cache@v3
        with:
          path: realesrgan-bin
          key: ${{ runner.os }}-realesrgan-v0.2.5.0

      - name: Setup Real-ESRGAN
        if: steps.cache-realesrgan.outputs.cache-hit != 'true'
        run: |
          echo "Downloading Real-ESRGAN binary..."
          mkdir -p realesrgan-bin
          wget -q https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesrgan-ncnn-vulkan-20220424-ubuntu.zip
          unzip -q realesrgan-ncnn-vulkan-20220424-ubuntu.zip -d realesrgan-bin
          chmod +x realesrgan-bin/realesrgan-ncnn-vulkan
          echo "Setup complete."

      - name: Process Images
        run: |
          # 実行ファイルのパスを通す
          RE_BIN="./realesrgan-bin/realesrgan-ncnn-vulkan"
          mkdir -p my-upscaler/output

          echo "Checking input directory..."
          ls -R my-upscaler/input/

          for file in my-upscaler/input/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "-----------------------------------"
              # ファイル名から倍率を抽出 (photo_x2.jpg -> 2, photo_x8.png -> 8, デフォルトは4)
              scale=4
              if [[ "$filename" =~ _x([2-8]) ]]; then
                scale="${BASH_REMATCH[1]}"
              fi
              
              echo "Using scale: $scale (Software GPU mode: llvmpipe)"
              
              # モデルディレクトリの指定が必要な場合があるため、カレントディレクトリに移動して実行
              pushd realesrgan-bin
              ./realesrgan-ncnn-vulkan -i "../$file" -o "../my-upscaler/output/upscaled_$filename" -s $scale -g 0
              popd
              
              echo "Finished processing: $filename"
            fi
          done

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          if [ -d "my-upscaler/output" ]; then
            git add my-upscaler/output/*
            if git status --porcelain | grep -q "^A  "; then
              git commit -m "Update upscaled images [skip ci]"
              git push
            else
              echo "No new images to commit."
            fi
          else
            echo "Output directory not found."
          fi
