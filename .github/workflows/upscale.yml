name: Upscale Image

on:
  workflow_dispatch:
    inputs:
      filename:
        description: "Specific filename to process (optional)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  upscale:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Install dependencies
        run: |
          sudo apt-get update -q
          sudo apt-get install -y -q libvulkan1 mesa-vulkan-drivers imagemagick

      - name: Cache Real-ESRGAN
        id: cache-realesrgan
        uses: actions/cache@v3
        with:
          path: realesrgan-bin
          key: ${{ runner.os }}-realesrgan-v0.2.5.0

      - name: Setup Real-ESRGAN
        if: steps.cache-realesrgan.outputs.cache-hit != 'true'
        run: |
          echo "Downloading Real-ESRGAN binary..."
          mkdir -p realesrgan-bin
          wget -q https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.5.0/realesrgan-ncnn-vulkan-20220424-ubuntu.zip
          unzip -q realesrgan-ncnn-vulkan-20220424-ubuntu.zip -d realesrgan-bin
          chmod +x realesrgan-bin/realesrgan-ncnn-vulkan
          echo "Setup complete."

      - name: Process Images
        run: |
          RE_BIN="./realesrgan-bin/realesrgan-ncnn-vulkan"
          mkdir -p my-upscaler/output
          mkdir -p my-upscaler/input/processed

          # 処理対象の決定
          TARGET_FILE="${{ github.event.inputs.filename }}"

          if [ -n "$TARGET_FILE" ]; then
            echo "Targeting specific file: $TARGET_FILE"
            FILES="my-upscaler/input/$TARGET_FILE"
          else
            echo "No specific file provided. Scanning input directory..."
            FILES=$(ls my-upscaler/input/* 2>/dev/null | grep -v "processed/") || true
          fi

          if [ -z "$FILES" ]; then
            echo "No files to process."
            exit 0
          fi

          for file in $FILES; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "-----------------------------------"
              echo "Processing image: $filename"
              
              # 倍率抽出 (photo_x2.jpg -> 2, photo_x8.png -> 8, デフォルトは4)
              scale=4
              if [[ "$filename" =~ _x([2-8]) ]]; then
                scale="${BASH_REMATCH[1]}"
              fi
              
              echo "Using scale: $scale (Software GPU mode: llvmpipe)"
              
              # 実行 (PNGで一旦出力)
              tmp_png="my-upscaler/output/tmp_${filename}.png"
              pushd realesrgan-bin
              ./realesrgan-ncnn-vulkan -i "../$file" -o "../$tmp_png" -s $scale -g 0
              popd
              
              # GitHubの100MB制限対策: JPEGに変換して圧縮
              echo "Converting to compressed JPEG to avoid 100MB limit..."
              out_name="${filename%.*}.jpg"
              convert "$tmp_png" -quality 95 "my-upscaler/output/upscaled_$out_name"
              rm "$tmp_png"
              
              # 処理済みフォルダへ移動
              mv "$file" my-upscaler/input/processed/
              
              echo "Finished processing: $filename -> upscaled_$out_name"
            fi
          done

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          git add my-upscaler/output/
          git add my-upscaler/input/

          if git status --porcelain | grep -q "^[AM]"; then
            git commit -m "Update upscaled images (compressed) and move to processed [skip ci]"
            git push
          else
            echo "No changes to commit."
          fi
